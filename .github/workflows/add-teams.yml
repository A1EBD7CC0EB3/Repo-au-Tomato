name: Add Teams to Repository
# /add-teams repo_name team1 team2 team3

on:
  issue_comment:
    types: [created]
env:
   ORG: 'A1EBD7CC0EB3'

jobs:
  add_teams:
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, '/add-teams')
    steps:
    - name: Check if user is admin of the repository
      id: checkAdmin
      env:
        GH_TOKEN: ${{ secrets.PAT }}
      run: |
        ARGS=$(echo '${{ github.event.comment.body }}' | awk -F'/add-teams ' '{print $2}' | tr -d '\r')
        ARG_ARRAY=($(echo "$ARGS"))
        REPO_NAME=${ARG_ARRAY[0]}
        IS_ADMIN=$(gh api -X GET /repos/${{ env.ORG }}/$REPO_NAME/collaborators/${{ github.event.comment.user.login }}/permission --jq '.permission == "admin"')
        echo "::set-output name=is_admin::$IS_ADMIN"

    - name: Add teams
      if: steps.checkAdmin.outputs.is_admin == 'true'
      id: addTeams
      env:
        GH_TOKEN: ${{ secrets.PAT }}
      run: |
        ARGS=$(echo '${{ github.event.comment.body }}' | awk -F'/add-teams ' '{print $2}' | tr -d '\r')
        ARG_ARRAY=($(echo "$ARGS"))
        REPO_NAME=${ARG_ARRAY[0]}
        ARG_ARRAY=("${ARG_ARRAY[@]:1}")
        for TEAM in "${ARG_ARRAY[@]}"; do
        #   if gh api -X GET /orgs/${{ env.ORG }}/teams/$TEAM > /dev/null 2>&1; then
            gh api -X PUT /orgs/${{ env.ORG }}/teams/$TEAM/repos/${{ env.ORG }}/$REPO_NAME -f permission=admin
        #   else
        #     echo "Team $TEAM does not exist"
        #   fi
        done

    - name: Comment success on adding teams
      if: steps.addTeams.outcome == 'success'
      env:
        GH_TOKEN: ${{ secrets.PAT }}
      run: |
        gh issue comment ${{ github.event.issue.number }} --repo ${{ env.ORG }}/${{ github.repository }} --body "Teams have been successfully added to the repository."

    - name: Comment failure on adding teams
      if: steps.addTeams.outcome == 'failure'
      env:
        GH_TOKEN: ${{ secrets.PAT }}
      run: |
        gh issue comment ${{ github.event.issue.number }} --repo ${{ env.ORG }}/${{ github.repository }} --body "There was an error adding teams to the repository make sure you have admin rights. Please try again."